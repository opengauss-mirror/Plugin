# 时间类型相关函数

新增openGauss对MySQL的时间相关函数的兼容。目前包括：MAKEDATE()、MAKETIME()、PERIOD_ADD()、PERIOD_DIFF()、SEC_TO_TIME() 、SUBDATE()

## MAKEDATE()
- 函数原型:
  
   `DATE MAKEDATE(int64 year, int64 dayofyear)`
- 功能描述：
    
    给定年份和天数，返回该年份在此年份天数下日期值。

- 备注:
  - 任一为NULL，函数返回NULL。
  - `dayofyear`必须大于0否则返回NULL。
  - 0 <= year < 70时：将year视作20XX年处理。 70 <= year < 100时：将year视作19XX年处理。
  - 返回结果限制在[0, 9999-12-31],超出范围返回NULL。
  
- 示例:

```sql
 openGauss=# SELECT MAKEDATE(2022,31), MAKEDATE(2022,32);
   makedate  |  makedate  
------------+------------
 2022-01-31 | 2022-02-01
(1 row)

-- 0<= year < 70 以及 70 <= year < 100
 openGauss=# SELECT MAKEDATE(0,31), MAKEDATE(70,32);
  makedate  |  makedate  
------------+------------
 2000-01-31 | 1970-02-01
(1 row)

-- dayofyear <= 0 以及 超出范围 的情况
 openGauss=# SELECT MAKEDATE(2022,0), MAKEDATE(9999,366);
  makedate | makedate 
----------+----------
          | 
(1 row)
```

## MAKETIME()
- 函数原型:

   `TIME MAKETIME(int64 hour, int64 minue, Numeric second)`
- 功能描述：
    
    给定小时、分钟和秒参数，返回TIME类型值。

- 备注:
  
  - 当参数满足如下任一条件时，函数返回NULL:
    1. minue < 0 or minue >= 60
    2. second < 0 or second >= 60
    3. 任一参数为NULL
  - 返回的Time结果保留6位小数，若second超出六位小数，则按照四舍五入进位。
  - 返回TIME类型值要求在[-838:59:59, 838:59:59]中。若超出范围，则根据hour的正负类型，来返回指定的边界值。
- 示例:
```sql
 openGauss=# SELECT MAKETIME(15, 15, 15.5);
  maketime  
------------
 15:15:15.5
(1 row)

-- 四舍五入进位
 openGauss=# SELECT MAKETIME(10, 15, 20.5000005);
    maketime     
-----------------
 10:15:20.500001
(1 row)

-- 四舍五入进位
 openGauss=# SELECT MAKETIME(839,0,0);
 maketime  
-----------
 838:59:59
(1 row)
```

## PERIOD_ADD()
- 函数原型:
  
   `int64 PERIOD_ADD(int64 P, int64 N)`
- 功能描述：
    
    返回时期`P`(格式为YYYYMM或YYMM)加上`N`个月后的时期值，格式为YYYYMM。

- 备注:
  
  - 当任一参数为NULL时，函数返回NULL。
  - `P` = 0时，返回0。
  - 参数的时期`P`与返回结果的时期中的年份小于100时，会以70为边界，将年份转为20XX年或19XX年。
- 示例:
```sql
 openGauss=# SELECT PERIOD_ADD(202201, 2);
  period_add 
------------
     202203
(1 row)
 
 -- p = 0
 openGauss=# SELECT PERIOD_ADD(0, 2);
 period_add 
------------
          0
(1 row)

 -- 时期的年份处于[0,70) 或 [70, 100)范围内
 openGauss=# SELECT PERIOD_ADD(0101, 2), PERIOD_ADD(7001, 2);
 period_add | period_add 
------------+------------
     200103 |     197003
(1 row)
```

## PERIOD_DIFF()
- 函数原型:
  
   `int64 PERIOD_DIFF(int64 P1, int64 P2)`
- 功能描述：
    
    返回两个时期参数`P1`与`P2`的月份数差值。

- 备注:
  
  - 当任一参数为NULL时，函数返回NULL。
  - 时期参数`P1`和`P2`中的年份小于100时，会以70为边界，将年份转为20XX年或19XX年。
- 示例:
```sql
 openGauss=# SELECT PERIOD_DIFF(202201,202003);
  period_diff 
-------------
          22
(1 row)

 openGauss=# SELECT PERIOD_DIFF(0101,7001);
 period_diff 
-------------
         372
(1 row)
```

## SEC_TO_TIME()
- 函数原型:
  
   `TIME SEC_TO_TIME(Numeric second)`
- 功能描述：
    
    给定秒数，将其转为小时、分钟与秒，返回TIME类型值。

- 备注:
  
  - 当任一参数为NULL，函数返回NULL。
  - 返回TIME类型值只保留小数点后6位，超出部分按照四舍五入规则进位。
  - 返回TIME类型值要求在[-838:59:59, 838:59:59]中。若超出范围，则根据second的正负类型，来返回指定的边界值。
- 示例:
```sql
 openGauss=# SELECT SEC_TO_TIME(4396);
 sec_to_time 
-------------
 01:13:16
(1 row)

-- 四舍五入进位
 openGauss=# SELECT SEC_TO_TIME(2378.2222225);
   sec_to_time   
-----------------
 00:39:38.222223
(1 row)

-- 返回结果超出范围
 openGauss=# SELECT SEC_TO_TIME(3888888);
 sec_to_time 
-------------
 838:59:59
(1 row)
```

## SUBDATE(expr, interval)
- 函数原型:
  
    `CString SUBDATE(text date, INTERVAL expr unit)`

    ​`CString SUBDATE(text date, int64 days)`
    
- 功能描述：
    
    该函数执行日期运算。参数`date`指定开始DATE或DATETIME类型值。指定要从开始日期减去的INTERVAL值，返回相减后的结果日期值。若第二参数为整数，则将其视为减去的天数值。

- 备注:
  
  - 函数返回格式为DATE或DATETIME。一般情况下，返回类型与第一参数的类型相同。当第一参数的类型为DATE时且INTERVAL的单位包含HOUR、MINUTE、SECOND部分，则返回结果为DATETIME。
  - 参数满足如下任一条件时，函数返回NULL：

    1. 参数date的日期超出范围[0, 9999-12-31]
    2. 任一参数为NULL。
  - 返回结果的日期必须在范围[0001-1-1, 9999-12-31]内。若越界，则返回NULL。
- 示例:
  
```sql
 openGauss=# SELECT SUBDATE('2022-01-01', INTERVAL 31 DAY), SUBDATE('2022-01-01', 31);
  subdate   |  subdate   
------------+------------
 2021-12-01 | 2021-12-01
(1 row)

-- 第一参数为DATE
 openGauss=# SELECT SUBDATE('2022-01-01 01:01:01', INTERVAL 1 YEAR);
       subdate       
---------------------
 2021-01-01 01:01:01
(1 row)

-- 第一参数为DATETIME
 openGauss=# SELECT SUBDATE('2022-01-01 01:01:01', INTERVAL 1 YEAR);
       subdate       
---------------------
 2021-01-01 01:01:01
(1 row)

-- 第一参数为DATE但是INTERVAL的单位包含TIME部分
 openGauss=# SELECT SUBDATE('2022-01-01', INTERVAL 1 SECOND);
       subdate       
---------------------
 2021-12-31 23:59:59
(1 row)
```

## SUBDATE(TIME, interval)
- 函数原型:
  
    `TIME SUBDATE(TIME time, INTERVAL expr unit)`
    
    `TIME SUBDATE(TIME time, int64 days)`
    
- 功能描述：
    
    该函数是为兼容MySql中subdate函数的第一参数类型可以为TIME的情况。该情况下，第一参数的输入必须为原始的TIME数据，而非由字符串的隐式转换而来。
    参数`time`指定开始TIME类型的时间值，第二参数指定要从开始时间减去的`INTERVAL`值，返回相减后的结果日期值。若第二参数为整数，则将其视为减去的天数值。

- 备注:
  
  - 第一参数必须为原始的TIME类型，而非由字符串的隐式转换而来。如SUBDATE('1:1:1', 1)并不会进入此函数。需改为SUBDATE(time'1:1:1', 1)
  - 第二参数的INTERVAL单位不能包含年或月部分，否则返回NULL。
  - 返回值必须在[-838:59:59, 838:59:59]内，否则返回NULL。
- 示例:

```sql
 openGauss=# SELECT SUBDATE(time'10:15:20', INTERVAL '1' DAY), SUBDATE(time'10:15:20', 1);
   subdate  |  subdate  
-----------+-----------
 -13:44:40 | -13:44:40
(1 row)

-- 第二参数的INTERVAL单位不能包含年或月部分
 openGauss=# SELECT SUBDATE(time'838:00:00', INTERVAL '1' MONTH);
 subdate 
---------
 
(1 row)

-- 结果超出范围
 openGauss=# SELECT SUBDATE(time'838:59:59', INTERVAL '-1' SECOND);
 subdate 
---------
 
(1 row)
```
 