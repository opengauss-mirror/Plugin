\c table_name_test_db;
set dolphin.lower_case_table_names TO 0;
--
--  CLUSTER
--
CREATE TABLE Clstr_tst_s (rf_a SERIAL PRIMARY KEY,
	b INT);
NOTICE:  CREATE TABLE will create implicit sequence "Clstr_tst_s_rf_a_seq" for serial column "Clstr_tst_s.rf_a"
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "Clstr_tst_s_pkey" for table "Clstr_tst_s"
CREATE TABLE Clstr_tst (a SERIAL PRIMARY KEY,
	b INT,
	c TEXT,
	d TEXT
	);
NOTICE:  CREATE TABLE will create implicit sequence "Clstr_tst_a_seq" for serial column "Clstr_tst.a"
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "Clstr_tst_pkey" for table "Clstr_tst"
CREATE INDEX Clstr_tst_b ON Clstr_tst (b);
CREATE INDEX Clstr_tst_c ON Clstr_tst (c);
CREATE INDEX Clstr_tst_c_b ON Clstr_tst (c,b);
CREATE INDEX Clstr_tst_b_c ON Clstr_tst (b,c);
INSERT INTO Clstr_tst_s (b) VALUES (0);
INSERT INTO Clstr_tst_s (b) SELECT b FROM Clstr_tst_s;
INSERT INTO Clstr_tst_s (b) SELECT b FROM Clstr_tst_s;
INSERT INTO Clstr_tst_s (b) SELECT b FROM Clstr_tst_s;
INSERT INTO Clstr_tst_s (b) SELECT b FROM Clstr_tst_s;
INSERT INTO Clstr_tst_s (b) SELECT b FROM Clstr_tst_s;
-- CREATE TABLE Clstr_tst_inh () INHERITS (Clstr_tst);
INSERT INTO Clstr_tst (b, c) VALUES (11, 'once');
INSERT INTO Clstr_tst (b, c) VALUES (10, 'diez');
INSERT INTO Clstr_tst (b, c) VALUES (31, 'treinta y uno');
INSERT INTO Clstr_tst (b, c) VALUES (22, 'veintidos');
INSERT INTO Clstr_tst (b, c) VALUES (3, 'tres');
INSERT INTO Clstr_tst (b, c) VALUES (20, 'veinte');
INSERT INTO Clstr_tst (b, c) VALUES (23, 'veintitres');
INSERT INTO Clstr_tst (b, c) VALUES (21, 'veintiuno');
INSERT INTO Clstr_tst (b, c) VALUES (4, 'cuatro');
INSERT INTO Clstr_tst (b, c) VALUES (14, 'catorce');
INSERT INTO Clstr_tst (b, c) VALUES (2, 'dos');
INSERT INTO Clstr_tst (b, c) VALUES (18, 'dieciocho');
INSERT INTO Clstr_tst (b, c) VALUES (27, 'veintisiete');
INSERT INTO Clstr_tst (b, c) VALUES (25, 'veinticinco');
INSERT INTO Clstr_tst (b, c) VALUES (13, 'trece');
INSERT INTO Clstr_tst (b, c) VALUES (28, 'veintiocho');
INSERT INTO Clstr_tst (b, c) VALUES (32, 'treinta y dos');
INSERT INTO Clstr_tst (b, c) VALUES (5, 'cinco');
INSERT INTO Clstr_tst (b, c) VALUES (29, 'veintinueve');
INSERT INTO Clstr_tst (b, c) VALUES (1, 'uno');
INSERT INTO Clstr_tst (b, c) VALUES (24, 'veinticuatro');
INSERT INTO Clstr_tst (b, c) VALUES (30, 'treinta');
INSERT INTO Clstr_tst (b, c) VALUES (12, 'doce');
INSERT INTO Clstr_tst (b, c) VALUES (17, 'diecisiete');
INSERT INTO Clstr_tst (b, c) VALUES (9, 'nueve');
INSERT INTO Clstr_tst (b, c) VALUES (19, 'diecinueve');
INSERT INTO Clstr_tst (b, c) VALUES (26, 'veintiseis');
INSERT INTO Clstr_tst (b, c) VALUES (15, 'quince');
INSERT INTO Clstr_tst (b, c) VALUES (7, 'siete');
INSERT INTO Clstr_tst (b, c) VALUES (16, 'dieciseis');
INSERT INTO Clstr_tst (b, c) VALUES (8, 'ocho');
-- This entry is needed to test that TOASTED values are copied correctly.
INSERT INTO Clstr_tst (b, c, d) VALUES (6, 'seis', repeat('xyzzy', 100000));
CLUSTER Clstr_tst_c ON Clstr_tst;
SELECT a,b,c,substring(d for 30), length(d) from Clstr_tst ORDER BY a, b, c;
 a  | b  |       c       |             substr             | length 
----+----+---------------+--------------------------------+--------
  1 | 11 | once          |                                |       
  2 | 10 | diez          |                                |       
  3 | 31 | treinta y uno |                                |       
  4 | 22 | veintidos     |                                |       
  5 |  3 | tres          |                                |       
  6 | 20 | veinte        |                                |       
  7 | 23 | veintitres    |                                |       
  8 | 21 | veintiuno     |                                |       
  9 |  4 | cuatro        |                                |       
 10 | 14 | catorce       |                                |       
 11 |  2 | dos           |                                |       
 12 | 18 | dieciocho     |                                |       
 13 | 27 | veintisiete   |                                |       
 14 | 25 | veinticinco   |                                |       
 15 | 13 | trece         |                                |       
 16 | 28 | veintiocho    |                                |       
 17 | 32 | treinta y dos |                                |       
 18 |  5 | cinco         |                                |       
 19 | 29 | veintinueve   |                                |       
 20 |  1 | uno           |                                |       
 21 | 24 | veinticuatro  |                                |       
 22 | 30 | treinta       |                                |       
 23 | 12 | doce          |                                |       
 24 | 17 | diecisiete    |                                |       
 25 |  9 | nueve         |                                |       
 26 | 19 | diecinueve    |                                |       
 27 | 26 | veintiseis    |                                |       
 28 | 15 | quince        |                                |       
 29 |  7 | siete         |                                |       
 30 | 16 | dieciseis     |                                |       
 31 |  8 | ocho          |                                |       
 32 |  6 | seis          | xyzzyxyzzyxyzzyxyzzyxyzzyxyzzy | 500000
(32 rows)

SELECT a,b,c,substring(d for 30), length(d) from Clstr_tst ORDER BY a;
 a  | b  |       c       |             substr             | length 
----+----+---------------+--------------------------------+--------
  1 | 11 | once          |                                |       
  2 | 10 | diez          |                                |       
  3 | 31 | treinta y uno |                                |       
  4 | 22 | veintidos     |                                |       
  5 |  3 | tres          |                                |       
  6 | 20 | veinte        |                                |       
  7 | 23 | veintitres    |                                |       
  8 | 21 | veintiuno     |                                |       
  9 |  4 | cuatro        |                                |       
 10 | 14 | catorce       |                                |       
 11 |  2 | dos           |                                |       
 12 | 18 | dieciocho     |                                |       
 13 | 27 | veintisiete   |                                |       
 14 | 25 | veinticinco   |                                |       
 15 | 13 | trece         |                                |       
 16 | 28 | veintiocho    |                                |       
 17 | 32 | treinta y dos |                                |       
 18 |  5 | cinco         |                                |       
 19 | 29 | veintinueve   |                                |       
 20 |  1 | uno           |                                |       
 21 | 24 | veinticuatro  |                                |       
 22 | 30 | treinta       |                                |       
 23 | 12 | doce          |                                |       
 24 | 17 | diecisiete    |                                |       
 25 |  9 | nueve         |                                |       
 26 | 19 | diecinueve    |                                |       
 27 | 26 | veintiseis    |                                |       
 28 | 15 | quince        |                                |       
 29 |  7 | siete         |                                |       
 30 | 16 | dieciseis     |                                |       
 31 |  8 | ocho          |                                |       
 32 |  6 | seis          | xyzzyxyzzyxyzzyxyzzyxyzzyxyzzy | 500000
(32 rows)

SELECT a,b,c,substring(d for 30), length(d) from Clstr_tst ORDER BY b;
 a  | b  |       c       |             substr             | length 
----+----+---------------+--------------------------------+--------
 20 |  1 | uno           |                                |       
 11 |  2 | dos           |                                |       
  5 |  3 | tres          |                                |       
  9 |  4 | cuatro        |                                |       
 18 |  5 | cinco         |                                |       
 32 |  6 | seis          | xyzzyxyzzyxyzzyxyzzyxyzzyxyzzy | 500000
 29 |  7 | siete         |                                |       
 31 |  8 | ocho          |                                |       
 25 |  9 | nueve         |                                |       
  2 | 10 | diez          |                                |       
  1 | 11 | once          |                                |       
 23 | 12 | doce          |                                |       
 15 | 13 | trece         |                                |       
 10 | 14 | catorce       |                                |       
 28 | 15 | quince        |                                |       
 30 | 16 | dieciseis     |                                |       
 24 | 17 | diecisiete    |                                |       
 12 | 18 | dieciocho     |                                |       
 26 | 19 | diecinueve    |                                |       
  6 | 20 | veinte        |                                |       
  8 | 21 | veintiuno     |                                |       
  4 | 22 | veintidos     |                                |       
  7 | 23 | veintitres    |                                |       
 21 | 24 | veinticuatro  |                                |       
 14 | 25 | veinticinco   |                                |       
 27 | 26 | veintiseis    |                                |       
 13 | 27 | veintisiete   |                                |       
 16 | 28 | veintiocho    |                                |       
 19 | 29 | veintinueve   |                                |       
 22 | 30 | treinta       |                                |       
  3 | 31 | treinta y uno |                                |       
 17 | 32 | treinta y dos |                                |       
(32 rows)

SELECT a,b,c,substring(d for 30), length(d) from Clstr_tst ORDER BY c;
 a  | b  |       c       |             substr             | length 
----+----+---------------+--------------------------------+--------
 10 | 14 | catorce       |                                |       
 18 |  5 | cinco         |                                |       
  9 |  4 | cuatro        |                                |       
 26 | 19 | diecinueve    |                                |       
 12 | 18 | dieciocho     |                                |       
 30 | 16 | dieciseis     |                                |       
 24 | 17 | diecisiete    |                                |       
  2 | 10 | diez          |                                |       
 23 | 12 | doce          |                                |       
 11 |  2 | dos           |                                |       
 25 |  9 | nueve         |                                |       
 31 |  8 | ocho          |                                |       
  1 | 11 | once          |                                |       
 28 | 15 | quince        |                                |       
 32 |  6 | seis          | xyzzyxyzzyxyzzyxyzzyxyzzyxyzzy | 500000
 29 |  7 | siete         |                                |       
 15 | 13 | trece         |                                |       
 22 | 30 | treinta       |                                |       
 17 | 32 | treinta y dos |                                |       
  3 | 31 | treinta y uno |                                |       
  5 |  3 | tres          |                                |       
 20 |  1 | uno           |                                |       
  6 | 20 | veinte        |                                |       
 14 | 25 | veinticinco   |                                |       
 21 | 24 | veinticuatro  |                                |       
  4 | 22 | veintidos     |                                |       
 19 | 29 | veintinueve   |                                |       
 16 | 28 | veintiocho    |                                |       
 27 | 26 | veintiseis    |                                |       
 13 | 27 | veintisiete   |                                |       
  7 | 23 | veintitres    |                                |       
  8 | 21 | veintiuno     |                                |       
(32 rows)

-- Verify that inheritance link still works
-- INSERT INTO Clstr_tst_inh VALUES (0, 100, 'in child table');
SELECT a,b,c,substring(d for 30), length(d) from Clstr_tst ORDER BY a, b, c;
 a  | b  |       c       |             substr             | length 
----+----+---------------+--------------------------------+--------
  1 | 11 | once          |                                |       
  2 | 10 | diez          |                                |       
  3 | 31 | treinta y uno |                                |       
  4 | 22 | veintidos     |                                |       
  5 |  3 | tres          |                                |       
  6 | 20 | veinte        |                                |       
  7 | 23 | veintitres    |                                |       
  8 | 21 | veintiuno     |                                |       
  9 |  4 | cuatro        |                                |       
 10 | 14 | catorce       |                                |       
 11 |  2 | dos           |                                |       
 12 | 18 | dieciocho     |                                |       
 13 | 27 | veintisiete   |                                |       
 14 | 25 | veinticinco   |                                |       
 15 | 13 | trece         |                                |       
 16 | 28 | veintiocho    |                                |       
 17 | 32 | treinta y dos |                                |       
 18 |  5 | cinco         |                                |       
 19 | 29 | veintinueve   |                                |       
 20 |  1 | uno           |                                |       
 21 | 24 | veinticuatro  |                                |       
 22 | 30 | treinta       |                                |       
 23 | 12 | doce          |                                |       
 24 | 17 | diecisiete    |                                |       
 25 |  9 | nueve         |                                |       
 26 | 19 | diecinueve    |                                |       
 27 | 26 | veintiseis    |                                |       
 28 | 15 | quince        |                                |       
 29 |  7 | siete         |                                |       
 30 | 16 | dieciseis     |                                |       
 31 |  8 | ocho          |                                |       
 32 |  6 | seis          | xyzzyxyzzyxyzzyxyzzyxyzzyxyzzy | 500000
(32 rows)

-- Verify that foreign key link still works
INSERT INTO Clstr_tst (b, c) VALUES (1111, 'this should fail');
SELECT conname FROM pg_constraint WHERE conrelid = 'Clstr_tst'::regclass
ORDER BY 1;
ERROR:  relation "clstr_tst" does not exist
LINE 1: ...ELECT conname FROM pg_constraint WHERE conrelid = 'Clstr_tst...
                                                             ^
SELECT relname, relkind,
    EXISTS(SELECT 1 FROM pg_class WHERE oid = c.reltoastrelid) AS hastoast
FROM pg_class c WHERE relname LIKE 'Clstr_tst%' ORDER BY relname;
       relname        | relkind | hastoast 
----------------------+---------+----------
 Clstr_tst            | r       | t
 Clstr_tst_a_seq      | S       | f
 Clstr_tst_pkey       | i       | f
 Clstr_tst_s          | r       | f
 Clstr_tst_s_pkey     | i       | f
 Clstr_tst_s_rf_a_seq | S       | f
(6 rows)

-- Verify that indisclustered is correctly set
SELECT pg_class.relname FROM pg_index, pg_class, pg_class AS pg_class_2
WHERE pg_class.oid=indexrelid
	AND indrelid=pg_class_2.oid
	AND pg_class_2.relname = 'Clstr_tst'
	AND indisclustered;
   relname   
-------------
 clstr_tst_c
(1 row)

-- Try changing indisclustered
ALTER TABLE Clstr_tst CLUSTER ON Clstr_tst_b_c;
SELECT pg_class.relname FROM pg_index, pg_class, pg_class AS pg_class_2
WHERE pg_class.oid=indexrelid
	AND indrelid=pg_class_2.oid
	AND pg_class_2.relname = 'Clstr_tst'
	AND indisclustered;
    relname    
---------------
 clstr_tst_b_c
(1 row)

-- Try turning off all clustering
ALTER TABLE Clstr_tst SET WITHOUT CLUSTER;
SELECT pg_class.relname FROM pg_index, pg_class, pg_class AS pg_class_2
WHERE pg_class.oid=indexrelid
	AND indrelid=pg_class_2.oid
	AND pg_class_2.relname = 'Clstr_tst'
	AND indisclustered;
 relname 
---------
(0 rows)

-- Verify that clustering all tables does in fact cluster the right ones
CREATE USER Clstr_user PASSWORD 'ttest@123';
NOTICE:  The iteration value of password is not recommended.Setting the iteration value too small reduces the security of the password, and setting it too large results in performance degradation.
CREATE TABLE Clstr_1 (a INT PRIMARY KEY);
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "Clstr_1_pkey" for table "Clstr_1"
CREATE TABLE Clstr_2 (a INT PRIMARY KEY);
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "Clstr_2_pkey" for table "Clstr_2"
CREATE TABLE Clstr_3 (a INT PRIMARY KEY);
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "Clstr_3_pkey" for table "Clstr_3"
ALTER TABLE Clstr_1 OWNER TO Clstr_user;
ALTER TABLE Clstr_3 OWNER TO Clstr_user;
GRANT SELECT ON Clstr_2 TO Clstr_user;
INSERT INTO Clstr_1 VALUES (2);
INSERT INTO Clstr_1 VALUES (1);
INSERT INTO Clstr_2 VALUES (2);
INSERT INTO Clstr_2 VALUES (1);
INSERT INTO Clstr_3 VALUES (2);
INSERT INTO Clstr_3 VALUES (1);
-- "CLUSTER <tablename>" on a table that hasn't been clustered
CLUSTER Clstr_2;
ERROR:  there is no previously clustered index for table "Clstr_2"
CLUSTER Clstr_1_pkey ON Clstr_1;
ERROR:  index "clstr_1_pkey" for table "Clstr_1" does not exist
CLUSTER Clstr_2 USING Clstr_2_pkey;
ERROR:  index "clstr_2_pkey" for table "Clstr_2" does not exist
SELECT * FROM Clstr_1 UNION ALL
  SELECT * FROM Clstr_2 UNION ALL
  SELECT * FROM Clstr_3
  ORDER BY 1;
 a 
---
 1
 1
 1
 2
 2
 2
(6 rows)

-- revert to the original state
DELETE FROM Clstr_1;
DELETE FROM Clstr_2;
DELETE FROM Clstr_3;
INSERT INTO Clstr_1 VALUES (2);
INSERT INTO Clstr_1 VALUES (1);
INSERT INTO Clstr_2 VALUES (2);
INSERT INTO Clstr_2 VALUES (1);
INSERT INTO Clstr_3 VALUES (2);
INSERT INTO Clstr_3 VALUES (1);
-- this user can only cluster Clstr_1 and Clstr_3, but the latter
-- has not been clustered
SET SESSION AUTHORIZATION Clstr_user PASSWORD 'ttest@123';
ERROR:  Invalid username/password,set session_authorization denied.
CLUSTER;
SELECT * FROM Clstr_1 UNION ALL
  SELECT * FROM Clstr_2 UNION ALL
  SELECT * FROM Clstr_3
  ORDER BY 1;
 a 
---
 1
 1
 1
 2
 2
 2
(6 rows)

-- cluster a single table using the indisclustered bit previously set
DELETE FROM Clstr_1;
INSERT INTO Clstr_1 VALUES (2);
INSERT INTO Clstr_1 VALUES (1);
CLUSTER Clstr_1;
ERROR:  there is no previously clustered index for table "Clstr_1"
SELECT * FROM Clstr_1
ORDER BY 1;
 a 
---
 1
 2
(2 rows)

-- Test MVCC-safety of cluster. There isn't much we can do to verify the
-- results with a single backend...
CREATE TABLE clustertest (key_a int PRIMARY KEY);
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "clustertest_pkey" for table "clustertest"
INSERT INTO clustertest VALUES (10);
INSERT INTO clustertest VALUES (20);
INSERT INTO clustertest VALUES (30);
INSERT INTO clustertest VALUES (40);
INSERT INTO clustertest VALUES (50);
-- Use a transaction so that updates are not committed when CLUSTER sees 'em
START TRANSACTION;
-- Test update where the old row version is found first in the scan
UPDATE clustertest SET key_a = 100 WHERE key_a = 10;
-- Test update where the new row version is found first in the scan
UPDATE clustertest SET key_a = 35 WHERE key_a = 40;
-- Test longer update chain
UPDATE clustertest SET key_a = 60 WHERE key_a = 50;
UPDATE clustertest SET key_a = 70 WHERE key_a = 60;
UPDATE clustertest SET key_a = 80 WHERE key_a = 70;
SELECT * FROM clustertest ORDER BY 1;
 key_a 
-------
    20
    30
    35
    80
   100
(5 rows)

CLUSTER clustertest_pkey ON clustertest;
ERROR:  CLUSTER cannot run inside a transaction block
SELECT * FROM clustertest ORDER BY 1;
ERROR:  current transaction is aborted, commands ignored until end of transaction block, firstChar[Q]
COMMIT;
SELECT * FROM clustertest ORDER BY 1;
 key_a 
-------
    10
    20
    30
    40
    50
(5 rows)

-- check that temp tables can be clustered
-- Enforce use of COMMIT instead of 2PC for temporary objects
RESET SESSION AUTHORIZATION;
SET SESSION AUTHORIZATION Clstr_user PASSWORD 'ttest@123';
ERROR:  Invalid username/password,set session_authorization denied.
create temp table Clstr_temp (col1 int primary key, col2 text);
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "Clstr_temp_pkey" for table "Clstr_temp"
insert into Clstr_temp values (2, 'two'), (1, 'one');
cluster Clstr_temp using Clstr_temp_pkey;
ERROR:  index "clstr_temp_pkey" for table "Clstr_temp" does not exist
select * from Clstr_temp order by 1;
 col1 | col2 
------+------
    1 | one
    2 | two
(2 rows)

drop table Clstr_temp;
DROP TABLE Clstr_2;
DROP TABLE Clstr_tst_s;
-- clean up
\c -
RESET SESSION AUTHORIZATION;
DROP USER "Clstr_user" CASCADE;
