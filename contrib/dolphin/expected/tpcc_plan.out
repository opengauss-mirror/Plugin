create schema tpcc_plan;
set current_schema to 'tpcc_plan';
drop table if exists warehouse;
NOTICE:  table "warehouse" does not exist, skipping
create table warehouse (
w_id smallint not null,
w_name varchar(10), 
w_street_1 varchar(20), 
w_street_2 varchar(20), 
w_city varchar(20), 
w_state char(2), 
w_zip char(9), 
w_tax decimal(4,2), 
w_ytd decimal(12,2),
primary key (w_id) ) Engine=InnoDB;
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "warehouse_pkey" for table "warehouse"
drop table if exists district;
NOTICE:  table "district" does not exist, skipping
create table district (
d_id tinyint not null, 
d_w_id smallint not null, 
d_name varchar(10), 
d_street_1 varchar(20), 
d_street_2 varchar(20), 
d_city varchar(20), 
d_state char(2), 
d_zip char(9), 
d_tax decimal(4,2), 
d_ytd decimal(12,2), 
d_next_o_id int,
primary key (d_w_id, d_id) ) Engine=InnoDB;
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "district_pkey" for table "district"
drop table if exists customer;
NOTICE:  table "customer" does not exist, skipping
create table customer (
c_id int not null, 
c_d_id tinyint not null,
c_w_id smallint not null, 
c_first varchar(16), 
c_middle char(2), 
c_last varchar(16), 
c_street_1 varchar(20), 
c_street_2 varchar(20), 
c_city varchar(20), 
c_state char(2), 
c_zip char(9), 
c_phone char(16), 
c_since datetime, 
c_credit char(2), 
c_credit_lim bigint, 
c_discount decimal(4,2), 
c_balance decimal(12,2), 
c_ytd_payment decimal(12,2), 
c_payment_cnt smallint, 
c_delivery_cnt smallint, 
c_data text,
PRIMARY KEY(c_w_id, c_d_id, c_id) ) Engine=InnoDB;
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "customer_pkey" for table "customer"
drop table if exists history;
NOTICE:  table "history" does not exist, skipping
create table history (
h_c_id int, 
h_c_d_id tinyint, 
h_c_w_id smallint,
h_d_id tinyint,
h_w_id smallint,
h_date datetime,
h_amount decimal(6,2), 
h_data varchar(24) ) Engine=InnoDB;
drop table if exists new_orders;
NOTICE:  table "new_orders" does not exist, skipping
create table new_orders (
no_o_id int not null,
no_d_id tinyint not null,
no_w_id smallint not null,
PRIMARY KEY(no_w_id, no_d_id, no_o_id)) Engine=InnoDB;
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "new_orders_pkey" for table "new_orders"
drop table if exists orders;
NOTICE:  table "orders" does not exist, skipping
create table orders (
o_id int not null, 
o_d_id tinyint not null, 
o_w_id smallint not null,
o_c_id int,
o_entry_d datetime,
o_carrier_id tinyint,
o_ol_cnt tinyint, 
o_all_local tinyint,
PRIMARY KEY(o_w_id, o_d_id, o_id) ) Engine=InnoDB ;
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "orders_pkey" for table "orders"
drop table if exists order_line;
NOTICE:  table "order_line" does not exist, skipping
create table order_line ( 
ol_o_id int not null, 
ol_d_id tinyint not null,
ol_w_id smallint not null,
ol_number tinyint not null,
ol_i_id int, 
ol_supply_w_id smallint,
ol_delivery_d datetime, 
ol_quantity tinyint, 
ol_amount decimal(6,2), 
ol_dist_info char(24),
PRIMARY KEY(ol_w_id, ol_d_id, ol_o_id, ol_number) ) Engine=InnoDB ;
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "order_line_pkey" for table "order_line"
drop table if exists item;
NOTICE:  table "item" does not exist, skipping
create table item (
i_id int not null, 
i_im_id int, 
i_name varchar(24), 
i_price decimal(5,2), 
i_data varchar(50),
PRIMARY KEY(i_id) ) Engine=InnoDB;
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "item_pkey" for table "item"
drop table if exists stock;
NOTICE:  table "stock" does not exist, skipping
create table stock (
s_i_id int not null, 
s_w_id smallint not null, 
s_quantity smallint, 
s_dist_01 char(24), 
s_dist_02 char(24),
s_dist_03 char(24),
s_dist_04 char(24), 
s_dist_05 char(24), 
s_dist_06 char(24), 
s_dist_07 char(24), 
s_dist_08 char(24), 
s_dist_09 char(24), 
s_dist_10 char(24), 
s_ytd decimal(8,0), 
s_order_cnt smallint, 
s_remote_cnt smallint,
s_data varchar(50),
PRIMARY KEY(s_w_id, s_i_id) ) Engine=InnoDB ;
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "stock_pkey" for table "stock"
analyze customer;  
analyze district; 
analyze history;
analyze item;
analyze new_orders;
analyze order_line;
analyze orders;
analyze stock;
analyze warehouse;
set enable_seqscan = off;
set dolphin.transform_unknown_param_type_as_column_type_first = true;
prepare s1 as SELECT c_discount, c_last, c_credit, w_tax FROM customer, warehouse WHERE w_id = ? AND c_w_id = w_id AND c_d_id = ? AND c_id = ?;
explain (costs off) execute s1 using 1, 2, 3;
                              QUERY PLAN                               
-----------------------------------------------------------------------
 Nested Loop
   ->  Index Scan using customer_pkey on customer
         Index Cond: ((c_w_id = $1) AND (c_d_id = $2) AND (c_id = $3))
   ->  Index Scan using warehouse_pkey on warehouse
         Index Cond: (w_id = $1)
(5 rows)

prepare s1 as SELECT d_next_o_id, d_tax FROM district WHERE d_id = ? AND d_w_id = ? FOR UPDATE;
explain (costs off) execute s1 using 1, 2;
                     QUERY PLAN                      
-----------------------------------------------------
 [Bypass]
 LockRows
   ->  Index Scan using district_pkey on district
         Index Cond: ((d_w_id = $2) AND (d_id = $1))
(4 rows)

prepare s1 as UPDATE district SET d_next_o_id = ? + 1 WHERE d_id = ? AND d_w_id = ?;
explain (costs off) execute s1 using 1, 2, 3;
                     QUERY PLAN                      
-----------------------------------------------------
 [Bypass]
 Update on district
   ->  Index Scan using district_pkey on district
         Index Cond: ((d_w_id = $3) AND (d_id = $2))
(4 rows)

prepare s1 as INSERT INTO orders (o_id, o_d_id, o_w_id, o_c_id, o_entry_d, o_ol_cnt, o_all_local) VALUES(?, ?, ?, ?, ?, ?, ?);
explain (costs off) execute s1 using 1, 2, 3, 4, '2024-10-10 10:10:10', 6, 7;
    QUERY PLAN    
------------------
 [Bypass]
 Insert on orders
   ->  Result
(3 rows)

prepare s1 as INSERT INTO new_orders (no_o_id, no_d_id, no_w_id) VALUES (?,?,?);
explain (costs off) execute s1 using 1, 2, 3;
      QUERY PLAN      
----------------------
 [Bypass]
 Insert on new_orders
   ->  Result
(3 rows)

prepare s1 as SELECT i_price, i_name, i_data FROM item WHERE i_id = ?;
explain (costs off) execute s1 using 1;
             QUERY PLAN             
------------------------------------
 [Bypass]
 Index Scan using item_pkey on item
   Index Cond: (i_id = $1)
(3 rows)

prepare s1 as SELECT s_quantity, s_data, s_dist_01, s_dist_02, s_dist_03, s_dist_04, s_dist_05, s_dist_06, s_dist_07, s_dist_08, s_dist_09, s_dist_10 FROM stock WHERE s_i_id = ? AND s_w_id = ? FOR UPDATE;
explain (costs off) execute s1 using 1, 2;
                      QUERY PLAN                       
-------------------------------------------------------
 [Bypass]
 LockRows
   ->  Index Scan using stock_pkey on stock
         Index Cond: ((s_w_id = $2) AND (s_i_id = $1))
(4 rows)

prepare s1 as UPDATE stock SET s_quantity = ? WHERE s_i_id = ? AND s_w_id = ?;
explain (costs off) execute s1 using 1, 2, 3;
                      QUERY PLAN                       
-------------------------------------------------------
 [Bypass]
 Update on stock
   ->  Index Scan using stock_pkey on stock
         Index Cond: ((s_w_id = $3) AND (s_i_id = $2))
(4 rows)

prepare s1 as INSERT INTO order_line (ol_o_id, ol_d_id, ol_w_id, ol_number, ol_i_id, ol_supply_w_id, ol_quantity, ol_amount, ol_dist_info) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?);
explain (costs off) execute s1 using 1, 2, 3, 4, 5, 6, 7, 8, 9;
      QUERY PLAN      
----------------------
 [Bypass]
 Insert on order_line
   ->  Result
(3 rows)

prepare s1 as UPDATE warehouse SET w_ytd = w_ytd + ? WHERE w_id = ?;
explain (costs off) execute s1 using 1, 2;
                     QUERY PLAN                     
----------------------------------------------------
 [Bypass]
 Update on warehouse
   ->  Index Scan using warehouse_pkey on warehouse
         Index Cond: (w_id = $2)
(4 rows)

prepare s1 as SELECT w_street_1, w_street_2, w_city, w_state, w_zip, w_name FROM warehouse WHERE w_id = ?;
explain (costs off) execute s1 using 1;
                  QUERY PLAN                  
----------------------------------------------
 [Bypass]
 Index Scan using warehouse_pkey on warehouse
   Index Cond: (w_id = $1)
(3 rows)

prepare s1 as UPDATE district SET d_ytd = d_ytd + ? WHERE d_w_id = ? AND d_id = ?;
explain (costs off) execute s1 using 1, 2, 3;
                     QUERY PLAN                      
-----------------------------------------------------
 [Bypass]
 Update on district
   ->  Index Scan using district_pkey on district
         Index Cond: ((d_w_id = $2) AND (d_id = $3))
(4 rows)

prepare s1 as SELECT d_street_1, d_street_2, d_city, d_state, d_zip, d_name FROM district WHERE d_w_id = ? AND d_id = ?;
explain (costs off) execute s1 using 1, 2;
                  QUERY PLAN                   
-----------------------------------------------
 [Bypass]
 Index Scan using district_pkey on district
   Index Cond: ((d_w_id = $1) AND (d_id = $2))
(3 rows)

prepare s1 as SELECT count(c_id) FROM customer WHERE c_w_id = ? AND c_d_id = ? AND c_last = ?;
explain (costs off) execute s1 using 1, 2, 3;
                      QUERY PLAN                       
-------------------------------------------------------
 Aggregate
   ->  Index Scan using customer_pkey on customer
         Index Cond: ((c_w_id = $1) AND (c_d_id = $2))
         Filter: ((c_last)::text = $3)
(4 rows)

prepare s1 as SELECT c_id FROM customer WHERE c_w_id = ? AND c_d_id = ? AND c_last = ? ORDER BY c_id;
explain (costs off) execute s1 using 1, 2, 3;
                   QUERY PLAN                    
-------------------------------------------------
 Index Scan using customer_pkey on customer
   Index Cond: ((c_w_id = $1) AND (c_d_id = $2))
   Filter: ((c_last)::text = $3)
(3 rows)

prepare s1 as SELECT c_first, c_middle, c_last, c_street_1, c_street_2, c_city, c_state, c_zip, c_phone, c_credit, c_credit_lim, c_discount, c_balance, c_since FROM customer WHERE c_w_id = ? AND c_d_id = ? AND c_id = ? FOR UPDATE;
explain (costs off) execute s1 using 1, 2, 3;
                              QUERY PLAN                               
-----------------------------------------------------------------------
 [Bypass]
 LockRows
   ->  Index Scan using customer_pkey on customer
         Index Cond: ((c_w_id = $1) AND (c_d_id = $2) AND (c_id = $3))
(4 rows)

prepare s1 as SELECT c_data FROM customer WHERE c_w_id = ? AND c_d_id = ? AND c_id = ?;
explain (costs off) execute s1 using 1, 2, 3;
                           QUERY PLAN                            
-----------------------------------------------------------------
 [Bypass]
 Index Scan using customer_pkey on customer
   Index Cond: ((c_w_id = $1) AND (c_d_id = $2) AND (c_id = $3))
(3 rows)

prepare s1 as UPDATE customer SET c_balance = ?, c_data = ? WHERE c_w_id = ? AND c_d_id = ? AND c_id = ?;
explain (costs off) execute s1 using 1, 2, 3, 4, 5;
                              QUERY PLAN                               
-----------------------------------------------------------------------
 [Bypass]
 Update on customer
   ->  Index Scan using customer_pkey on customer
         Index Cond: ((c_w_id = $3) AND (c_d_id = $4) AND (c_id = $5))
(4 rows)

prepare s1 as UPDATE customer SET c_balance = ? WHERE c_w_id = ? AND c_d_id = ? AND c_id = ?;
explain (costs off) execute s1 using 1, 2, 3, 4;
                              QUERY PLAN                               
-----------------------------------------------------------------------
 [Bypass]
 Update on customer
   ->  Index Scan using customer_pkey on customer
         Index Cond: ((c_w_id = $2) AND (c_d_id = $3) AND (c_id = $4))
(4 rows)

prepare s1 as INSERT INTO history(h_c_d_id, h_c_w_id, h_c_id, h_d_id, h_w_id, h_date, h_amount, h_data) VALUES(?, ?, ?, ?, ?, ?, ?, ?);
explain (costs off) execute s1 using 1, 2, 3, 4, 5, '2024-10-10 10:10:10', 7, 8;
    QUERY PLAN     
-------------------
 [Bypass]
 Insert on history
   ->  Result
(3 rows)

prepare s1 as SELECT count(c_id) FROM customer WHERE c_w_id = ? AND c_d_id = ? AND c_last = ?;
explain (costs off) execute s1 using 1, 2, 3;
                      QUERY PLAN                       
-------------------------------------------------------
 Aggregate
   ->  Index Scan using customer_pkey on customer
         Index Cond: ((c_w_id = $1) AND (c_d_id = $2))
         Filter: ((c_last)::text = $3)
(4 rows)

prepare s1 as SELECT c_balance, c_first, c_middle, c_last FROM customer WHERE c_w_id = ? AND c_d_id = ? AND c_last = ? ORDER BY c_first;
explain (costs off) execute s1 using 1, 2, 3;
                      QUERY PLAN                       
-------------------------------------------------------
 Sort
   Sort Key: c_first NULLS FIRST
   ->  Index Scan using customer_pkey on customer
         Index Cond: ((c_w_id = $1) AND (c_d_id = $2))
         Filter: ((c_last)::text = $3)
(5 rows)

prepare s1 as SELECT c_balance, c_first, c_middle, c_last FROM customer WHERE c_w_id = ? AND c_d_id = ? AND c_id = ?;
explain (costs off) execute s1 using 1, 2, 3;
                           QUERY PLAN                            
-----------------------------------------------------------------
 [Bypass]
 Index Scan using customer_pkey on customer
   Index Cond: ((c_w_id = $1) AND (c_d_id = $2) AND (c_id = $3))
(3 rows)

prepare s1 as SELECT o_id, o_entry_d, COALESCE(o_carrier_id,0) FROM orders WHERE o_w_id = ? AND o_d_id = ? AND o_c_id = ? AND o_id = (SELECT MAX(o_id) FROM orders WHERE o_w_id = ? AND o_d_id = ? AND o_c_id = ?);
explain (costs off) execute s1 using 1, 2, 3, 4, 5, 6;
                              QUERY PLAN                               
-----------------------------------------------------------------------
 Index Scan using orders_pkey on orders
   Index Cond: ((o_w_id = $1) AND (o_d_id = $2) AND (o_id = $1))
   Filter: (o_c_id = $3)
   InitPlan 2 (returns $1)
     ->  Result
           InitPlan 1 (returns $0)
             ->  Limit
                   ->  Index Scan Backward using orders_pkey on orders
                         Index Cond: ((o_w_id = $4) AND (o_d_id = $5))
                         Filter: (o_c_id = $6)
(10 rows)

prepare s1 as SELECT ol_i_id, ol_supply_w_id, ol_quantity, ol_amount, ol_delivery_d FROM order_line WHERE ol_w_id = ? AND ol_d_id = ? AND ol_o_id = ?;
explain (costs off) execute s1 using 1, 2, 3;
                              QUERY PLAN                              
----------------------------------------------------------------------
 [Bypass]
 Index Scan using order_line_pkey on order_line
   Index Cond: ((ol_w_id = $1) AND (ol_d_id = $2) AND (ol_o_id = $3))
(3 rows)

prepare s1 as SELECT COALESCE(MIN(no_o_id),0) FROM new_orders WHERE no_d_id = ? AND no_w_id = ?;
explain (costs off) execute s1 using 1, 2;
                            QUERY PLAN                             
-------------------------------------------------------------------
 Result
   InitPlan 1 (returns $0)
     ->  Limit
           ->  Index Only Scan using new_orders_pkey on new_orders
                 Index Cond: ((no_w_id = $2) AND (no_d_id = $1))
(5 rows)

prepare s1 as DELETE FROM new_orders WHERE no_o_id = ? AND no_d_id = ? AND no_w_id = ?;
explain (costs off) execute s1 using 1, 2, 3;
                                 QUERY PLAN                                 
----------------------------------------------------------------------------
 [Bypass]
 Delete on new_orders
   ->  Index Scan using new_orders_pkey on new_orders
         Index Cond: ((no_w_id = $3) AND (no_d_id = $2) AND (no_o_id = $1))
(4 rows)

prepare s1 as SELECT o_c_id FROM orders WHERE o_id = ? AND o_d_id = ? AND o_w_id = ?;
explain (costs off) execute s1 using 1, 2, 3;
                           QUERY PLAN                            
-----------------------------------------------------------------
 [Bypass]
 Index Scan using orders_pkey on orders
   Index Cond: ((o_w_id = $3) AND (o_d_id = $2) AND (o_id = $1))
(3 rows)

prepare s1 as UPDATE orders SET o_carrier_id = ? WHERE o_id = ? AND o_d_id = ? AND o_w_id = ?;
explain (costs off) execute s1 using 1, 2, 3, 4;
                              QUERY PLAN                               
-----------------------------------------------------------------------
 [Bypass]
 Update on orders
   ->  Index Scan using orders_pkey on orders
         Index Cond: ((o_w_id = $4) AND (o_d_id = $3) AND (o_id = $2))
(4 rows)

prepare s1 as UPDATE order_line SET ol_delivery_d = ? WHERE ol_o_id = ? AND ol_d_id = ? AND ol_w_id = ?;
explain (costs off) execute s1 using '2024-10-10 10:10:10', 2, 3, 4;
                                 QUERY PLAN                                 
----------------------------------------------------------------------------
 [Bypass]
 Update on order_line
   ->  Index Scan using order_line_pkey on order_line
         Index Cond: ((ol_w_id = $4) AND (ol_d_id = $3) AND (ol_o_id = $2))
(4 rows)

prepare s1 as SELECT SUM(ol_amount) FROM order_line WHERE ol_o_id = ? AND ol_d_id = ? AND ol_w_id = ?;
explain (costs off) execute s1 using 1, 2, 3;
                                 QUERY PLAN                                 
----------------------------------------------------------------------------
 Aggregate
   ->  Index Scan using order_line_pkey on order_line
         Index Cond: ((ol_w_id = $3) AND (ol_d_id = $2) AND (ol_o_id = $1))
(3 rows)

prepare s1 as UPDATE customer SET c_balance = c_balance + ? , c_delivery_cnt = c_delivery_cnt + 1 WHERE c_id = ? AND c_d_id = ? AND c_w_id = ?;
explain (costs off) execute s1 using 1, 2, 3, 4;
                              QUERY PLAN                               
-----------------------------------------------------------------------
 Update on customer
   ->  Index Scan using customer_pkey on customer
         Index Cond: ((c_w_id = $4) AND (c_d_id = $3) AND (c_id = $2))
(3 rows)

prepare s1 as SELECT d_next_o_id FROM district WHERE d_id = ? AND d_w_id = ?;
explain (costs off) execute s1 using 1, 2;
                  QUERY PLAN                   
-----------------------------------------------
 [Bypass]
 Index Scan using district_pkey on district
   Index Cond: ((d_w_id = $2) AND (d_id = $1))
(3 rows)

prepare s1 as SELECT DISTINCT ol_i_id FROM order_line WHERE ol_w_id = ? AND ol_d_id = ? AND ol_o_id < ? AND ol_o_id >= (? - 20);
explain (costs off) execute s1 using 1, 2, 3, 4;
                                  QUERY PLAN                                  
------------------------------------------------------------------------------
 HashAggregate
   Group By Key: ol_i_id
   ->  Index Scan using order_line_pkey on order_line
         Index Cond: ((ol_w_id = $1) AND (ol_d_id = $2) AND (ol_o_id < $3))
         Filter: ((ol_o_id)::double precision >= ($4 - 20::double precision))
(5 rows)

prepare s1 as SELECT count(*) FROM stock WHERE s_w_id = ? AND s_i_id = ? AND s_quantity < ?;
explain (costs off) execute s1 using 1, 2, 3;
                      QUERY PLAN                       
-------------------------------------------------------
 Aggregate
   ->  Index Scan using stock_pkey on stock
         Index Cond: ((s_w_id = $1) AND (s_i_id = $2))
         Filter: (s_quantity < $3)
(4 rows)

drop table customer;  
drop table district; 
drop table history;
drop table item;
drop table new_orders;
drop table order_line;
drop table orders;
drop table stock;
drop table warehouse;
drop schema tpcc_plan cascade;
reset current_schema;
