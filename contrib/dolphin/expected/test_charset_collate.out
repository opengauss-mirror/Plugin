create schema test_charset;
set current_schema to 'test_charset';
set dolphin.b_compatibility_mode = off;
create database test1;
create database test2 encoding 'utf8';
create database test2 charset 'utf8';
ERROR:  create schema/database with charset need to set dolphin.b_compatibility_mode on.
drop database if exists test1;
drop database if exists test2;
set dolphin.b_compatibility_mode = on;
create database test3;
NOTICE:  CREATE DATABASE will change to CREATE SCHEMA when dolphin.b_compatibility_mode is on.
select nspcollation from pg_namespace where nspname='test3';
 nspcollation 
--------------
             
(1 row)

create table test3.test33(a varchar(10));
drop table test3.test33;
create database test4 encoding 'utf8';
create database test5 charset 'utf8';
NOTICE:  CREATE DATABASE will change to CREATE SCHEMA when dolphin.b_compatibility_mode is on.
create database test6 with charset 'utf8';
ERROR:  syntax error at or near "charset"
LINE 1: create database test6 with charset 'utf8';
                                   ^
create database test7 with encoding 'utf8';
drop database if exists test3;
NOTICE:  DROP DATABASE will change to DROP SCHEMA when dolphin.b_compatibility_mode is on.
drop database if exists test4;
NOTICE:  DROP DATABASE will change to DROP SCHEMA when dolphin.b_compatibility_mode is on.
NOTICE:  schema "test4" does not exist, skipping
drop database if exists test5;
NOTICE:  DROP DATABASE will change to DROP SCHEMA when dolphin.b_compatibility_mode is on.
drop database if exists test6;
NOTICE:  DROP DATABASE will change to DROP SCHEMA when dolphin.b_compatibility_mode is on.
NOTICE:  schema "test6" does not exist, skipping
drop database if exists test7;
NOTICE:  DROP DATABASE will change to DROP SCHEMA when dolphin.b_compatibility_mode is on.
NOTICE:  schema "test7" does not exist, skipping
create database if not exists test4 encoding 'utf8';
NOTICE:  database "test4" already exists, skipping
drop database test4;
NOTICE:  DROP DATABASE will change to DROP SCHEMA when dolphin.b_compatibility_mode is on.
ERROR:  schema "test4" does not exist
create database if not exists test5 charset 'utf8';
NOTICE:  CREATE DATABASE will change to CREATE SCHEMA when dolphin.b_compatibility_mode is on.
drop database test5;
NOTICE:  DROP DATABASE will change to DROP SCHEMA when dolphin.b_compatibility_mode is on.
set dolphin.b_compatibility_mode = off;
create database test1;
alter database test1 connection limit 200;
alter database test1;
alter database test1 charset 'utf8';
ERROR:  create database with charset need to set dolphin.b_compatibility_mode on.
alter database test1 collate 'utf8';
ERROR:  create database with charset need to set dolphin.b_compatibility_mode on.
drop database if exists test1;
set dolphin.b_compatibility_mode = on;
alter database test1 connection limit 200;
ERROR:  database "test1" does not exist
alter database test1 ;
ERROR:  database "test1" does not exist
alter database test1 charset 'utf8';
NOTICE:  ALTER DATABASE will change to ALTER SCHEMA when dolphin.b_compatibility_mode is on.
ERROR:  schema "test1" does not exist
create database test1;
NOTICE:  CREATE DATABASE will change to CREATE SCHEMA when dolphin.b_compatibility_mode is on.
alter database test1 charset 'utf8';
NOTICE:  ALTER DATABASE will change to ALTER SCHEMA when dolphin.b_compatibility_mode is on.
alter database test1 collate 'utf8';
NOTICE:  ALTER DATABASE will change to ALTER SCHEMA when dolphin.b_compatibility_mode is on.
WARNING:  Invalid collation detected. default value set
drop database if exists test1;
NOTICE:  DROP DATABASE will change to DROP SCHEMA when dolphin.b_compatibility_mode is on.
select 'a' > 'A' collate 'aaa';
WARNING:  Invalid collation detected. default value set
 ?column? 
----------
 f
(1 row)

select 'a' > 'A' collate 'utf8mb4_bin';
 ?column? 
----------
 t
(1 row)

-- invalid column collate
create table test_collate0(c1 text charset 'utf8mb4' collate 'binary');
create table test_collate1 (c1 text collate 'aaa', c2 text collate 'utf8mb4_bin', c3 text charset 'aaa' collate 'aaa');
WARNING:  aaa is not a valid encoding name. default value set
WARNING:  Invalid collation for column c1 detected. default value set
WARNING:  Invalid collation for column c3 detected. default value set
alter table test_collate1 add column c4 text charset 'aaa' collate 'aaa';
WARNING:  aaa is not a valid encoding name. default value set
WARNING:  Invalid collation for column c4 detected. default value set
alter table test_collate1 modify column c1 text collate 'bbb';
WARNING:  Invalid collation for column c1 detected. default value set
select pg_get_tabledef('test_collate1');
                    pg_get_tabledef                    
-------------------------------------------------------
 SET search_path = test_charset;                      +
 CREATE TABLE test_collate1 (                         +
     c1 text,                                         +
     c2 text CHARACTER SET "UTF8" COLLATE utf8mb4_bin,+
     c3 text,                                         +
     c4 text                                          +
 )                                                    +
 WITH (orientation=row, compression=no);
(1 row)

-- invalid table collate
create table test_collate2(c1 text collate 'aaa', c2 text collate 'utf8mb4_bin')charset 'aaa';
WARNING:  aaa is not a valid encoding name. default value set
WARNING:  Invalid collation for column c1 detected. default value set
alter table test_collate2 add column c4 text charset 'aaa' collate 'aaa';
WARNING:  aaa is not a valid encoding name. default value set
WARNING:  Invalid collation for column c4 detected. default value set
alter table test_collate2 modify column c1 text collate 'bbb';
WARNING:  Invalid collation for column c1 detected. default value set
select pg_get_tabledef('test_collate2');
                    pg_get_tabledef                    
-------------------------------------------------------
 SET search_path = test_charset;                      +
 CREATE TABLE test_collate2 (                         +
     c1 text,                                         +
     c2 text CHARACTER SET "UTF8" COLLATE utf8mb4_bin,+
     c4 text                                          +
 )                                                    +
 WITH (orientation=row, compression=no);
(1 row)

create table test_collate3(c1 text collate 'aaa', c2 text collate 'utf8mb4_bin')charset 'utf8' collate 'aaa';
WARNING:  Invalid collation for column c1 detected. default value set
WARNING:  Invalid collation detected. default value set
create table test_collate4(c1 text collate 'aaa', c2 text charset 'aaa', c3 text collate 'utf8mb4_general_ci')charset 'utf8mb4' collate 'utf8mb4_bin';
WARNING:  aaa is not a valid encoding name. default value set
WARNING:  Invalid collation for column c1 detected. default value set
alter table test_collate4 add column c4 text charset 'aaa' collate 'aaa';
WARNING:  aaa is not a valid encoding name. default value set
WARNING:  Invalid collation for column c4 detected. default value set
alter table test_collate4 modify column c1 text collate 'bbb';
WARNING:  Invalid collation for column c1 detected. default value set
create table test_collate5(c1 text collate 'aaa', c2 text collate 'utf8mb4_bin', c3 text)collate 'aaa';
WARNING:  Invalid collation for column c1 detected. default value set
WARNING:  Invalid collation detected. default value set
-- different charset
show b_format_behavior_compat_options;
 b_format_behavior_compat_options 
----------------------------------
 
(1 row)

create table test_collate6(a text) charset gbk;
ERROR:  difference between the charset and the database encoding has not supported
create table test_collate6(a text) collate gbk_bin;
ERROR:  difference between the charset and the database encoding has not supported
-- invalid schema collate
create schema test1 charset 'aaa';
WARNING:  aaa is not a valid encoding name. default value set
set schema 'test1';
create table test_collate6(c1 text, c2 text collate 'utf8mb4_bin');
create table test_collate7(c1 text, c2 text collate 'utf8mb4_bin');
create table test_collate8(c1 text) charset 'utf8';
create table test_collate9(c1 text) charset 'aaa';
WARNING:  aaa is not a valid encoding name. default value set
create table test_collate10(c1 text);
create schema if not exists sch_ddl_0078 character set = utf8 collate utf8_unicode_ci;
drop schema sch_ddl_0078;
--test binary
set dolphin.b_compatibility_mode = true;
set bytea_output = 'escape';
drop table if exists test_binary1;
NOTICE:  table "test_binary1" does not exist, skipping
create table test_binary1(
    f1 blob collate 'binary'
);
insert into test_binary1 values('ppp'),('PpP'),('PPP'),('AAA'),('Aaa'),('aaa'),('Š'),('S');
select distinct f1 from test_binary1 order by f1;
    f1    
----------
 AAA
 Aaa
 PPP
 PpP
 S
 aaa
 ppp
 \305\240
(8 rows)

select f1 from test_binary1 where f1 = 'ppp'::blob collate 'binary';
 f1  
-----
 ppp
(1 row)

select f1 from test_binary1 where f1 = 'ppp'::blob collate 'utf8mb4_bin';
ERROR:  COLLATION "utf8mb4_bin" is not valid for binary type
LINE 1: ...elect f1 from test_binary1 where f1 = 'ppp'::blob collate 'u...
                                                             ^
alter table test_binary1 add column f2 tinyblob collate 'binary';
insert into test_binary1 (f2) values('ppp'),('PpP'),('PPP'),('AAA'),('Aaa'),('aaa'),('Š'),('S');
select distinct f2 from test_binary1 order by f2;
    f2    
----------
 
 AAA
 Aaa
 PPP
 PpP
 S
 aaa
 ppp
 \305\240
(9 rows)

select f2 from test_binary1 where f2 = 'ppp'::blob collate 'binary';
 f2  
-----
 ppp
(1 row)

select f2 from test_binary1 where f2 = 'ppp'::blob collate 'utf8mb4_bin';
ERROR:  COLLATION "utf8mb4_bin" is not valid for binary type
LINE 1: ...elect f2 from test_binary1 where f2 = 'ppp'::blob collate 'u...
                                                             ^
alter table test_binary1 add column f3 mediumblob collate 'binary';
alter table test_binary1 add column f4 binary collate 'binary';
alter table test_binary1 add column f5 varbinary collate 'binary';
alter table test_binary1 add column f6 text collate 'binary';
alter table test_binary1 add column f7 int collate 'binary';
ERROR:  collations are not supported by type integer
LINE 1: alter table test_binary1 add column f7 int collate 'binary';
                                                   ^
drop table if exists test_binary2;
NOTICE:  table "test_binary2" does not exist, skipping
create table test_binary2(c1 text, c2 varchar(10), c3 char(10), c4 tinytext) collate 'binary';
alter table test_binary2 add column c5 text;
alter table test_binary2 add column c6 varchar(10);
alter table test_binary2 add column c6 varchar(10) collate 'utf8mb4_bin';
ERROR:  column "c6" of relation "test_binary2" already exists
alter table test_binary2 add column c7 char(10);
alter table test_binary2 add column c8 tinytext;
select pg_get_tabledef('test_binary2');
                          pg_get_tabledef                           
--------------------------------------------------------------------
 SET search_path = test1;                                          +
 CREATE TABLE test_binary2 (                                       +
     c1 blob CHARACTER SET "SQL_ASCII" COLLATE "binary",           +
     c2 "varbinary"(10) CHARACTER SET "SQL_ASCII" COLLATE "binary",+
     c3 "binary"(10) CHARACTER SET "SQL_ASCII" COLLATE "binary",   +
     c4 blob CHARACTER SET "SQL_ASCII" COLLATE "binary",           +
     c5 blob CHARACTER SET "SQL_ASCII" COLLATE "binary",           +
     c6 "varbinary"(10) CHARACTER SET "SQL_ASCII" COLLATE "binary",+
     c7 "binary"(10) CHARACTER SET "SQL_ASCII" COLLATE "binary",   +
     c8 blob CHARACTER SET "SQL_ASCII" COLLATE "binary"            +
 )                                                                 +
 CHARACTER SET = "SQL_ASCII" COLLATE = "binary"                    +
 WITH (orientation=row, compression=no);
(1 row)

--binary/ascii attribute
create schema bin_schema_test character set = utf8 collate utf8_unicode_ci;
use bin_schema_test;
set b_format_behavior_compat_options='enable_multi_charset'; -- use to enable different table charset with schema
create table t_bin(a text binary);
\d t_bin
            Table "bin_schema_test.t_bin"
 Column | Type |              Modifiers              
--------+------+-------------------------------------
 a      | text | character set UTF8 collate utf8_bin

create table t_bin2(a text character set gbk binary);
\d t_bin2
          Table "bin_schema_test.t_bin2"
 Column | Type |             Modifiers             
--------+------+-----------------------------------
 a      | text | character set GBK collate gbk_bin

create table t_bin3(a text binary) character set gb18030;
\d t_bin3
              Table "bin_schema_test.t_bin3"
 Column | Type |                 Modifiers                 
--------+------+-------------------------------------------
 a      | text | character set GB18030 collate gb18030_bin

-- binary has high proirity than collate clause
create table t_bin4(a text binary collate gb18030_chinese_ci);
\d t_bin4
              Table "bin_schema_test.t_bin4"
 Column | Type |                 Modifiers                 
--------+------+-------------------------------------------
 a      | text | character set GB18030 collate gb18030_bin

create table t_bin5(a text binary character set gbk) character set gb18030;
\d t_bin5
          Table "bin_schema_test.t_bin5"
 Column | Type |             Modifiers             
--------+------+-----------------------------------
 a      | text | character set GBK collate gbk_bin

-- ascii
create table t_bin6(a text ascii collate 'af_ZA.iso88591', b text charset binary binary);
show create table t_bin6;
 Table  |                        Create Table                         
--------+-------------------------------------------------------------
 t_bin6 | SET search_path = bin_schema_test;                         +
        | CREATE TABLE t_bin6 (                                      +
        |     a text CHARACTER SET "LATIN1" COLLATE "af_ZA.iso88591",+
        |     b blob CHARACTER SET "SQL_ASCII" COLLATE "binary"      +
        | )                                                          +
        | CHARACTER SET = "UTF8" COLLATE = "utf8_unicode_ci"         +
        | WITH (orientation=row, compression=no);
(1 row)

--alter table
alter table t_bin6 add column c text binary;
show create table t_bin6;
 Table  |                        Create Table                         
--------+-------------------------------------------------------------
 t_bin6 | SET search_path = bin_schema_test;                         +
        | CREATE TABLE t_bin6 (                                      +
        |     a text CHARACTER SET "LATIN1" COLLATE "af_ZA.iso88591",+
        |     b blob CHARACTER SET "SQL_ASCII" COLLATE "binary",     +
        |     c text CHARACTER SET "UTF8" COLLATE utf8_bin           +
        | )                                                          +
        | CHARACTER SET = "UTF8" COLLATE = "utf8_unicode_ci"         +
        | WITH (orientation=row, compression=no);
(1 row)

alter table t_bin6 add column d text character set gbk binary;
show create table t_bin6;
 Table  |                        Create Table                         
--------+-------------------------------------------------------------
 t_bin6 | SET search_path = bin_schema_test;                         +
        | CREATE TABLE t_bin6 (                                      +
        |     a text CHARACTER SET "LATIN1" COLLATE "af_ZA.iso88591",+
        |     b blob CHARACTER SET "SQL_ASCII" COLLATE "binary",     +
        |     c text CHARACTER SET "UTF8" COLLATE utf8_bin,          +
        |     d text CHARACTER SET "GBK" COLLATE gbk_bin             +
        | )                                                          +
        | CHARACTER SET = "UTF8" COLLATE = "utf8_unicode_ci"         +
        | WITH (orientation=row, compression=no);
(1 row)

alter table t_bin6 add column e text binary character set gbk;
show create table t_bin6;
 Table  |                        Create Table                         
--------+-------------------------------------------------------------
 t_bin6 | SET search_path = bin_schema_test;                         +
        | CREATE TABLE t_bin6 (                                      +
        |     a text CHARACTER SET "LATIN1" COLLATE "af_ZA.iso88591",+
        |     b blob CHARACTER SET "SQL_ASCII" COLLATE "binary",     +
        |     c text CHARACTER SET "UTF8" COLLATE utf8_bin,          +
        |     d text CHARACTER SET "GBK" COLLATE gbk_bin,            +
        |     e text CHARACTER SET "GBK" COLLATE gbk_bin             +
        | )                                                          +
        | CHARACTER SET = "UTF8" COLLATE = "utf8_unicode_ci"         +
        | WITH (orientation=row, compression=no);
(1 row)

alter table t_bin6 modify column a text binary;
show create table t_bin6;
 Table  |                      Create Table                      
--------+--------------------------------------------------------
 t_bin6 | SET search_path = bin_schema_test;                    +
        | CREATE TABLE t_bin6 (                                 +
        |     a text CHARACTER SET "UTF8" COLLATE utf8_bin,     +
        |     b blob CHARACTER SET "SQL_ASCII" COLLATE "binary",+
        |     c text CHARACTER SET "UTF8" COLLATE utf8_bin,     +
        |     d text CHARACTER SET "GBK" COLLATE gbk_bin,       +
        |     e text CHARACTER SET "GBK" COLLATE gbk_bin        +
        | )                                                     +
        | CHARACTER SET = "UTF8" COLLATE = "utf8_unicode_ci"    +
        | WITH (orientation=row, compression=no);
(1 row)

alter table t_bin6 modify column a text character set gbk binary;
show create table t_bin6;
 Table  |                      Create Table                      
--------+--------------------------------------------------------
 t_bin6 | SET search_path = bin_schema_test;                    +
        | CREATE TABLE t_bin6 (                                 +
        |     a text CHARACTER SET "GBK" COLLATE gbk_bin,       +
        |     b blob CHARACTER SET "SQL_ASCII" COLLATE "binary",+
        |     c text CHARACTER SET "UTF8" COLLATE utf8_bin,     +
        |     d text CHARACTER SET "GBK" COLLATE gbk_bin,       +
        |     e text CHARACTER SET "GBK" COLLATE gbk_bin        +
        | )                                                     +
        | CHARACTER SET = "UTF8" COLLATE = "utf8_unicode_ci"    +
        | WITH (orientation=row, compression=no);
(1 row)

alter table t_bin6 modify column a text binary character set gb18030;
show create table t_bin6;
 Table  |                      Create Table                       
--------+---------------------------------------------------------
 t_bin6 | SET search_path = bin_schema_test;                     +
        | CREATE TABLE t_bin6 (                                  +
        |     a text CHARACTER SET "GB18030" COLLATE gb18030_bin,+
        |     b blob CHARACTER SET "SQL_ASCII" COLLATE "binary", +
        |     c text CHARACTER SET "UTF8" COLLATE utf8_bin,      +
        |     d text CHARACTER SET "GBK" COLLATE gbk_bin,        +
        |     e text CHARACTER SET "GBK" COLLATE gbk_bin         +
        | )                                                      +
        | CHARACTER SET = "UTF8" COLLATE = "utf8_unicode_ci"     +
        | WITH (orientation=row, compression=no);
(1 row)

alter table t_bin6 change column b b_new text binary;
show create table t_bin6;
 Table  |                      Create Table                       
--------+---------------------------------------------------------
 t_bin6 | SET search_path = bin_schema_test;                     +
        | CREATE TABLE t_bin6 (                                  +
        |     a text CHARACTER SET "GB18030" COLLATE gb18030_bin,+
        |     b_new text CHARACTER SET "UTF8" COLLATE utf8_bin,  +
        |     c text CHARACTER SET "UTF8" COLLATE utf8_bin,      +
        |     d text CHARACTER SET "GBK" COLLATE gbk_bin,        +
        |     e text CHARACTER SET "GBK" COLLATE gbk_bin         +
        | )                                                      +
        | CHARACTER SET = "UTF8" COLLATE = "utf8_unicode_ci"     +
        | WITH (orientation=row, compression=no);
(1 row)

alter table t_bin6 change column b_new b_new2 text charset gb18030 binary;
show create table t_bin6;
 Table  |                         Create Table                         
--------+--------------------------------------------------------------
 t_bin6 | SET search_path = bin_schema_test;                          +
        | CREATE TABLE t_bin6 (                                       +
        |     a text CHARACTER SET "GB18030" COLLATE gb18030_bin,     +
        |     b_new2 text CHARACTER SET "GB18030" COLLATE gb18030_bin,+
        |     c text CHARACTER SET "UTF8" COLLATE utf8_bin,           +
        |     d text CHARACTER SET "GBK" COLLATE gbk_bin,             +
        |     e text CHARACTER SET "GBK" COLLATE gbk_bin              +
        | )                                                           +
        | CHARACTER SET = "UTF8" COLLATE = "utf8_unicode_ci"          +
        | WITH (orientation=row, compression=no);
(1 row)

alter table t_bin6 change column b_new2 b_new3 text binary charset gbk;
show create table t_bin6;
 Table  |                      Create Table                       
--------+---------------------------------------------------------
 t_bin6 | SET search_path = bin_schema_test;                     +
        | CREATE TABLE t_bin6 (                                  +
        |     a text CHARACTER SET "GB18030" COLLATE gb18030_bin,+
        |     b_new3 text CHARACTER SET "GBK" COLLATE gbk_bin,   +
        |     c text CHARACTER SET "UTF8" COLLATE utf8_bin,      +
        |     d text CHARACTER SET "GBK" COLLATE gbk_bin,        +
        |     e text CHARACTER SET "GBK" COLLATE gbk_bin         +
        | )                                                      +
        | CHARACTER SET = "UTF8" COLLATE = "utf8_unicode_ci"     +
        | WITH (orientation=row, compression=no);
(1 row)

-- ascii, grammar is ok, but execute report error
create table t_bin7(a text binary ascii);
ERROR:  default collation for encoding "LATIN1" does not exist
create table t_bin8(a text ascii binary);
ERROR:  default collation for encoding "LATIN1" does not exist
create table t_bin9(a text ascii);
ERROR:  default collation for encoding "LATIN1" does not exist
-- wrong grammar
create table t_bin10(a text collate gb18030_chinese_ci binary);
ERROR:  syntax error at or near "binary"
LINE 1: ...ate table t_bin10(a text collate gb18030_chinese_ci binary);
                                                               ^
create table t_bin11(a text collate gb18030_chinese_ci ascii);
ERROR:  syntax error at or near "ascii"
LINE 1: ...eate table t_bin11(a text collate gb18030_chinese_ci ascii);
                                                                ^
create table t_bin12(a text character set gbk ascii);
ERROR:  syntax error at or near "ascii"
LINE 1: create table t_bin12(a text character set gbk ascii);
                                                      ^
create table t_bin13(a text ascii character set gbk);
ERROR:  syntax error at or near "character"
LINE 1: create table t_bin13(a text ascii character set gbk);
                                          ^
drop schema bin_schema_test cascade;
NOTICE:  drop cascades to 6 other objects
DETAIL:  drop cascades to table t_bin
drop cascades to table t_bin2
drop cascades to table t_bin3
drop cascades to table t_bin4
drop cascades to table t_bin5
drop cascades to table t_bin6
drop schema test_charset cascade;
NOTICE:  drop cascades to 6 other objects
DETAIL:  drop cascades to table test_charset.test_collate0
drop cascades to table test_charset.test_collate1
drop cascades to table test_charset.test_collate2
drop cascades to table test_charset.test_collate3
drop cascades to table test_charset.test_collate4
drop cascades to table test_charset.test_collate5
reset current_schema;
create schema test_b1 charset='utf8' collate='utf8_general_ci';
set current_schema to 'test_b1';
set b_format_behavior_compat_options = 'default_collation,enable_multi_charset';
create table test1(id int, pic longblob) charset=utf8mb4 collate=utf8mb4_0900_ai_ci;
WARNING:  Invalid collation detected. default value set
reset b_format_behavior_compat_options;
create table test2(id int, pic longblob) charset=utf8mb4 collate=utf8mb4_0900_ai_ci;
WARNING:  Invalid collation detected. default value set
show create table test1;
 Table |                        Create Table                         
-------+-------------------------------------------------------------
 test1 | SET search_path = test_b1;                                 +
       | CREATE TABLE test1 (                                       +
       |     id integer,                                            +
       |     pic longblob CHARACTER SET "SQL_ASCII" COLLATE "binary"+
       | )                                                          +
       | CHARACTER SET = "UTF8" COLLATE = "utf8_general_ci"         +
       | WITH (orientation=row, compression=no);
(1 row)

show create table test2;
 Table |              Create Table               
-------+-----------------------------------------
 test2 | SET search_path = test_b1;             +
       | CREATE TABLE test2 (                   +
       |     id integer,                        +
       |     pic longblob                       +
       | )                                      +
       | CHARACTER SET = "" COLLATE = "default" +
       | WITH (orientation=row, compression=no);
(1 row)

drop table test1;
drop table test2;
drop schema test_b1 cascade;
reset current_schema;
