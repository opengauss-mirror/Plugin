drop database if exists format_test;
create database format_test dbcompatibility 'B';
\c format_test
create extension b_sql_plugin;
-- test for b_format_mode = false
select format(1234.456, 2);
  format  
----------
 1234.456
(1 row)

select format(1234.456, 2, 'en_US');
  format  
----------
 1234.456
(1 row)

select format('%1s!', 'Hello');
 format 
--------
 Hello!
(1 row)

select format('%1s %1s!', 'Hello', 'world');
    format    
--------------
 Hello world!
(1 row)

-- test for b_format_mode = true
set b_format_mode = 1;
-- test for basic functionality of FORMAT
select format(234.567, 3);
 format  
---------
 234.567
(1 row)

select format(234.567, 2);
 format 
--------
 234.57
(1 row)

select format(234.567, 1);
 format 
--------
 234.6
(1 row)

select format(234.567, 8);
    format    
--------------
 234.56700000
(1 row)

select format(234.567, 0);
 format 
--------
 235
(1 row)

-- test for carry
select format(999.999, 3);
 format  
---------
 999.999
(1 row)

select format(999.999, 2);
  format  
----------
 1,000.00
(1 row)

select format(999.999, 0);
 format 
--------
 1,000
(1 row)

-- test for thousand separator
select format(1234.45, 0);
 format 
--------
 1,234
(1 row)

select format(1234567.89, 1);
   format    
-------------
 1,234,567.9
(1 row)

-- test for different locale
select format(1234.45, 2, 'en_US');
  format  
----------
 1,234.45
(1 row)

select format(1234.45, 2, 'de_DE');
  format  
----------
 1.234,45
(1 row)

select format(1234.45, 2, 'fr_FR');
 format  
---------
 1234,45
(1 row)

-- test for type check
select format(1234.456, 2.49);
  format  
----------
 1,234.46
(1 row)

select format(1234.456, 2.99);
  format   
-----------
 1,234.456
(1 row)

-- wrong type of first param
select format('abcde', 2);
ERROR:  invalid input syntax for type double precision: "abcde"
LINE 1: select format('abcde', 2);
                      ^
CONTEXT:  referenced column: format
-- non-existent locale input
select format(1234.456, 2, 'zz_AA');
ERROR:  the provided locale is invalid.
CONTEXT:  referenced column: format
-- wrong type of third param
select format(1234.456, 2, 123123);
ERROR:  the provided locale is invalid.
CONTEXT:  referenced column: format
-- test for setting b_format_mode back to false
set b_format_mode = 0;
select format(1234.456, 2);
  format  
----------
 1234.456
(1 row)

select format(1234.456, 2, 'en_US');
  format  
----------
 1234.456
(1 row)

select format('%1s!', 'Hello');
 format 
--------
 Hello!
(1 row)

select format('%1s %1s!', 'Hello', 'world');
    format    
--------------
 Hello world!
(1 row)

\c postgres
drop database format_test;
-- test for A compatibility to ensure the original functionality is good.
create database db_a_format_test dbcompatibility 'A';
\c db_a_format_test
select format(1234.456, 2);
  format  
----------
 1234.456
(1 row)

select format(1234.456, 2, 'en_US');
  format  
----------
 1234.456
(1 row)

\c postgres
drop database db_a_format_test;
