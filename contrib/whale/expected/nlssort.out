-- Tests for nlssort
SET client_min_messages = default;
SET behavior_compat_options = 'accept_empty_str';
CREATE TABLE test_sort (name TEXT);
INSERT INTO test_sort VALUES ('red'), ('brown'), ('yellow'), ('Purple');
SELECT * FROM test_sort ORDER BY NLSSORT(name, 'en_US.utf8');
  name  
--------
 Purple
 yellow
 red
 brown
(4 rows)

SELECT * FROM test_sort ORDER BY NLSSORT(name, '');
  name  
--------
 Purple
 yellow
 red
 brown
(4 rows)

SELECT set_nls_sort('invalid');
 set_nls_sort 
--------------
 
(1 row)

SELECT * FROM test_sort ORDER BY NLSSORT(name);
ERROR:  failed to set the requested LC_COLLATE value [invalid]
CONTEXT:  referenced column: nlssort
SQL function "nlssort" statement 1
SELECT set_nls_sort('');
 set_nls_sort 
--------------
 
(1 row)

SELECT * FROM test_sort ORDER BY NLSSORT(name);
  name  
--------
 Purple
 yellow
 red
 brown
(4 rows)

SELECT set_nls_sort('en_US.utf8');
 set_nls_sort 
--------------
 
(1 row)

SELECT * FROM test_sort ORDER BY NLSSORT(name);
  name  
--------
 Purple
 yellow
 red
 brown
(4 rows)

INSERT INTO test_sort VALUES(NULL);
SELECT * FROM test_sort ORDER BY NLSSORT(name);
  name  
--------
 Purple
 yellow
 red
 brown
 
(5 rows)

-- Tests for SQL_ASCII
SET client_min_messages = error;
DROP DATABASE IF EXISTS regression_sort;
CREATE DATABASE regression_sort WITH TEMPLATE = template0 ENCODING='SQL_ASCII' LC_COLLATE='C' LC_CTYPE='C';
\c regression_sort
SET client_min_messages = error;
SET behavior_compat_options = 'accept_empty_str';
CREATE EXTENSION whale;
SET client_min_messages = default;
CREATE TABLE test_sort (name TEXT);
INSERT INTO test_sort VALUES ('red'), ('brown'), ('yellow'), ('Purple');
SELECT * FROM test_sort ORDER BY NLSSORT(name, 'en_US.utf8');
  name  
--------
 Purple
 brown
 red
 yellow
(4 rows)

SELECT * FROM test_sort ORDER BY NLSSORT(name, '');
  name  
--------
 Purple
 brown
 red
 yellow
(4 rows)

SELECT set_nls_sort('invalid');
 set_nls_sort 
--------------
 
(1 row)

SELECT * FROM test_sort ORDER BY NLSSORT(name);
ERROR:  failed to set the requested LC_COLLATE value [invalid]
CONTEXT:  referenced column: nlssort
SQL function "nlssort" statement 1
SELECT set_nls_sort('');
 set_nls_sort 
--------------
 
(1 row)

SELECT * FROM test_sort ORDER BY NLSSORT(name);
  name  
--------
 Purple
 brown
 red
 yellow
(4 rows)

SELECT set_nls_sort('en_US.utf8');
 set_nls_sort 
--------------
 
(1 row)

SELECT * FROM test_sort ORDER BY NLSSORT(name);
  name  
--------
 Purple
 brown
 red
 yellow
(4 rows)

INSERT INTO test_sort VALUES(NULL);
SELECT * FROM test_sort ORDER BY NLSSORT(name);
  name  
--------
 Purple
 brown
 red
 yellow
 
(5 rows)

